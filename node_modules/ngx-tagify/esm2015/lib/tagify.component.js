import { Component, ElementRef, EventEmitter, forwardRef, Input, Output, ViewChild } from '@angular/core';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { asyncScheduler, BehaviorSubject, fromEvent, merge, Observable, Subject } from 'rxjs';
import { takeUntil, throttleTime } from 'rxjs/operators';
import Tagify from '@yaireo/tagify';
import { TagifyService } from './tagify.service';
export class TagifyComponent {
    constructor(tagifyService, element) {
        this.tagifyService = tagifyService;
        this.element = element;
        this.valueType = 'undefined';
        this.onChange = Function.prototype;
        this.onTouched = Function.prototype;
        this.unsubscribe$ = new Subject();
        this.value$ = new BehaviorSubject(null);
        this.skip = false;
        this.inputClassValue = '';
        this.readonlyValue = false;
        this.settings = {};
        this.name = '';
        this.add = new EventEmitter();
        this.remove = new EventEmitter();
        this.tInput = new EventEmitter();
    }
    set inputClass(v) {
        this.setTagsClass(v);
        this.inputClassValue = v;
    }
    set readonly(v) {
        this.readonlyValue = !!v;
        this.setReadonly();
    }
    get value() {
        return this.valueData;
    }
    set value(v) {
        if (v !== this.valueData) {
            this.valueData = v;
            this.onChange(v);
        }
    }
    ngAfterViewInit() {
        this.settings.callbacks = this.settings.callbacks || {};
        if (!this.settings.callbacks.hasOwnProperty('add')) {
            this.settings.callbacks.add = () => this.add.emit({
                tags: this.tagify.value,
                added: this.tagify.value[this.tagify.value.length - 1]
            });
        }
        if (!this.settings.callbacks.hasOwnProperty('remove')) {
            this.settings.callbacks.remove = () => this.remove.emit(this.tagify.value);
        }
        const innerText = this.element.nativeElement.textContent;
        this.tagify = new Tagify(this.inputRef.nativeElement, this.settings);
        // add to service if name is provided
        if (this.name.length) {
            this.tagifyService.add(this.name, this.tagify);
        }
        this.setReadonly();
        // if there is some text inside component, load this value and skip first change check
        if (innerText.length) {
            this.tagify.loadOriginalValues(innerText);
            this.skip = true;
            setTimeout(() => {
                this.setValue();
            });
        }
        // listen to value changes from outside
        this.value$
            .pipe(takeUntil(this.unsubscribe$))
            .subscribe(tags => {
            if (!tags) {
                return;
            }
            if (this.skip) {
                this.skip = false;
                return;
            }
            if (this.valueType === 'undefined') {
                this.valueType = typeof tags;
            }
            // if string is passed, e.g. via reactive forms
            if (typeof tags === 'string') {
                this.tagify.loadOriginalValues(tags);
                setTimeout(() => {
                    this.setValue();
                });
                return;
            }
            // add all tags (already existing tags will be skipped
            this.tagify.addTags(tags, false, true);
            // remove all tags that are not part of value anymore
            this.tagify.value.forEach(v => {
                if (!tags.find(t => t.value === v.value)) {
                    // somehow removeTags() with string parameter doesn't always find the tag element
                    // this is a workaround for finding the right tag element
                    const tagElm = this.tagify.getTagElms().find(el => el.attributes.getNamedItem('value').textContent === v.value);
                    this.tagify.removeTags(tagElm);
                }
            });
        });
        // listen to tagify events
        this.tagify.on('input', e => {
            this.tInput.emit(e.detail.value);
            if (this.valueType === 'string' && this.tagify.settings.mode === 'mix') {
                this.value = this.tagify.getMixedTagsAsString();
            }
        });
        merge(fromEvent(this.tagify, 'add'), fromEvent(this.tagify, 'remove'))
            .pipe(
        // throttle used to reduce number of value changes when adding/removing a bunch of tags
        throttleTime(0, asyncScheduler, { leading: false, trailing: true }), takeUntil(this.unsubscribe$))
            .subscribe(() => {
            this.setValue();
        });
        // listen to suggestions updates
        if (this.whitelist) {
            this.whitelist
                .pipe(takeUntil(this.unsubscribe$))
                .subscribe(list => {
                this.tagify.settings.whitelist = list;
            });
        }
    }
    writeValue(tags) {
        this.value$.next(tags);
    }
    registerOnChange(fn) {
        this.onChange = fn;
    }
    registerOnTouched(fn) {
        this.onTouched = fn;
    }
    setValue() {
        if (this.valueType === 'string') {
            this.value = this.tagify.DOM.originalInput.value;
        }
        else {
            this.value = this.tagify.value.slice();
        }
    }
    /**
     * Tagify creates a `tags` element to which the classes of the `input` element are applied.
     * Changes of `inputClass` are applied automatically to the `input` element, but have to be
     * manually applied to the `tags` element.
     */
    setTagsClass(v) {
        const tagsElement = this.element.nativeElement.querySelector('tags');
        if (tagsElement) {
            tagsElement.classList.remove(...this.inputClassValue.split(/\s+/));
            tagsElement.classList.add(...v.split(/\s+/));
        }
    }
    setReadonly() {
        if (this.tagify) {
            this.tagify.setReadonly(this.readonlyValue);
        }
    }
    ngOnDestroy() {
        this.unsubscribe$.next();
        this.unsubscribe$.complete();
        this.tagify.destroy();
        if (this.name.length) {
            this.tagifyService.remove(this.name);
        }
    }
}
TagifyComponent.decorators = [
    { type: Component, args: [{
                selector: 'tagify',
                template: `<input [ngClass]="inputClassValue" #inputRef/>
    <span style="display: none"><ng-content></ng-content></span>`,
                providers: [{
                        provide: NG_VALUE_ACCESSOR,
                        useExisting: forwardRef(() => TagifyComponent),
                        multi: true
                    }]
            },] }
];
TagifyComponent.ctorParameters = () => [
    { type: TagifyService },
    { type: ElementRef }
];
TagifyComponent.propDecorators = {
    inputRef: [{ type: ViewChild, args: ['inputRef', { static: true },] }],
    settings: [{ type: Input }],
    name: [{ type: Input }],
    whitelist: [{ type: Input }],
    inputClass: [{ type: Input }],
    readonly: [{ type: Input }],
    add: [{ type: Output }],
    remove: [{ type: Output }],
    tInput: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFnaWZ5LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi9wcm9qZWN0cy9uZ3gtdGFnaWZ5L3NyYy8iLCJzb3VyY2VzIjpbImxpYi90YWdpZnkuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCxTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFBRSxVQUFVLEVBQ3hCLEtBQUssRUFFTCxNQUFNLEVBQ04sU0FBUyxFQUNWLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBd0IsaUJBQWlCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsY0FBYyxFQUFFLGVBQWUsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDOUYsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RCxPQUFPLE1BQW1DLE1BQU0sZ0JBQWdCLENBQUM7QUFDakUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBWWpELE1BQU0sT0FBTyxlQUFlO0lBNEMxQixZQUNVLGFBQTRCLEVBQzVCLE9BQWdDO1FBRGhDLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLFlBQU8sR0FBUCxPQUFPLENBQXlCO1FBM0NsQyxjQUFTLEdBQUcsV0FBVyxDQUFDO1FBQ3hCLGFBQVEsR0FBUSxRQUFRLENBQUMsU0FBUyxDQUFDO1FBQ25DLGNBQVMsR0FBUSxRQUFRLENBQUMsU0FBUyxDQUFDO1FBRXBDLGlCQUFZLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUNuQyxXQUFNLEdBQUcsSUFBSSxlQUFlLENBQW1CLElBQUksQ0FBQyxDQUFDO1FBRXJELFNBQUksR0FBRyxLQUFLLENBQUM7UUFFckIsb0JBQWUsR0FBRyxFQUFFLENBQUM7UUFDckIsa0JBQWEsR0FBRyxLQUFLLENBQUM7UUFJYixhQUFRLEdB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VztRQUNqQixJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDZixJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7U0FDN0M7SUFDSCxDQUFDO0lBRUQsV0FBVztRQUNULElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDekIsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUU3QixJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRXRCLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDcEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3RDO0lBQ0gsQ0FBQzs7O1lBcE5GLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsUUFBUTtnQkFDbEIsUUFBUSxFQUFFO2lFQUNxRDtnQkFDL0QsU0FBUyxFQUFFLENBQUM7d0JBQ1YsT0FBTyxFQUFFLGlCQUFpQjt3QkFDMUIsV0FBVyxFQUFFLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxlQUFlLENBQUM7d0JBQzlDLEtBQUssRUFBRSxJQUFJO3FCQUNaLENBQUM7YUFDSDs7O1lBWFEsYUFBYTtZQVhwQixVQUFVOzs7dUJBc0NULFNBQVMsU0FBQyxVQUFVLEVBQUUsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFDO3VCQUVwQyxLQUFLO21CQUNMLEtBQUs7d0JBQ0wsS0FBSzt5QkFDTCxLQUFLO3VCQUlMLEtBQUs7a0JBZ0JMLE1BQU07cUJBQ04sTUFBTTtxQkFDTixNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsIGZvcndhcmRSZWYsXG4gIElucHV0LFxuICBPbkRlc3Ryb3ksXG4gIE91dHB1dCxcbiAgVmlld0NoaWxkXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ29udHJvbFZhbHVlQWNjZXNzb3IsIE5HX1ZBTFVFX0FDQ0VTU09SIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgYXN5bmNTY2hlZHVsZXIsIEJlaGF2aW9yU3ViamVjdCwgZnJvbUV2ZW50LCBtZXJnZSwgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFrZVVudGlsLCB0aHJvdHRsZVRpbWUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgVGFnaWZ5LCB7IFRhZ0RhdGEsIFRhZ2lmeVNldHRpbmdzIH0gZnJvbSAnQHlhaXJlby90YWdpZnknO1xuaW1wb3J0IHsgVGFnaWZ5U2VydmljZSB9IGZyb20gJy4vdGFnaWZ5LnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICd0YWdpZnknLFxuICB0ZW1wbGF0ZTogYDxpbnB1dCBbbmdDbGFzc109XCJpbnB1dENsYXNzVmFsdWVcIiAjaW5wdXRSZWYvPlxuICAgIDxzcGFuIHN0eWxlPVwiZGlzcGxheTogbm9uZVwiPjxuZy1jb250ZW50PjwvbmctY29udGVudD48L3NwYW4+YCxcbiAgcHJvdmlkZXJzOiBbe1xuICAgIHByb3ZpZGU6IE5HX1ZBTFVFX0FDQ0VTU09SLFxuICAgIHVzZUV4aXN0aW5nOiBmb3J3YXJkUmVmKCgpID0+IFRhZ2lmeUNvbXBvbmVudCksXG4gICAgbXVsdGk6IHRydWVcbiAgfV1cbn0pXG5leHBvcnQgY2xhc3MgVGFnaWZ5Q29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgQ29udHJvbFZhbHVlQWNjZXNzb3IsIE9uRGVzdHJveSB7XG5cbiAgcHJpdmF0ZSB2YWx1ZURhdGE6IHN0cmluZ3xUYWdEYXRhW107XG4gIHByaXZhdGUgdmFsdWVUeXBlID0gJ3VuZGVmaW5lZCc7XG4gIHByaXZhdGUgb25DaGFuZ2U6IGFueSA9IEZ1bmN0aW9uLnByb3RvdHlwZTtcbiAgcHJpdmF0ZSBvblRvdWNoZWQ6IGFueSA9IEZ1bmN0aW9uLnByb3RvdHlwZTtcblxuICBwcml2YXRlIHVuc3Vic2NyaWJlJCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG4gIHByaXZhdGUgdmFsdWUkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmd8VGFnRGF0YVtdPihudWxsKTtcbiAgcHJpdmF0ZSB0YWdpZnk6IFRhZ2lmeTtcbiAgcHJpdmF0ZSBza2lwID0gZmFsc2U7XG5cbiAgaW5wdXRDbGFzc1ZhbHVlID0gJyc7XG4gIHJlYWRvbmx5VmFsdWUgPSBmYWxzZTtcblxuICBAVmlld0NoaWxkKCdpbnB1dFJlZicsIHtzdGF0aWM6IHRydWV9KSBpbnB1dFJlZjogRWxlbWVudFJlZjxIVE1MSW5wdXRFbGVtZW50PjtcblxuICBASW5wdXQoKSBzZXR0aW5nczogVGFnaWZ5U2V0dGluZ3MgPSB7fTtcbiAgQElucHV0KCkgbmFtZSA9ICcnO1xuICBASW5wdXQoKSB3aGl0ZWxpc3Q6IE9ic2VydmFibGU8c3RyaW5nW118VGFnRGF0YVtdPjtcbiAgQElucHV0KCkgc2V0IGlucHV0Q2xhc3Modjogc3RyaW5nKSB7XG4gICAgdGhpcy5zZXRUYWdzQ2xhc3Modik7XG4gICAgdGhpcy5pbnB1dENsYXNzVmFsdWUgPSB2O1xuICB9XG4gIEBJbnB1dCgpIHNldCByZWFkb25seSh2OiBib29sZWFuKSB7XG4gICAgdGhpcy5yZWFkb25seVZhbHVlID0gISF2O1xuICAgIHRoaXMuc2V0UmVhZG9ubHkoKTtcbiAgfVxuXG4gIGdldCB2YWx1ZSgpOiBzdHJpbmd8VGFnRGF0YVtdIHtcbiAgICByZXR1cm4gdGhpcy52YWx1ZURhdGE7XG4gIH1cblxuICBzZXQgdmFsdWUodjogc3RyaW5nfFRhZ0RhdGFbXSkge1xuICAgIGlmICh2ICE9PSB0aGlzLnZhbHVlRGF0YSkge1xuICAgICAgdGhpcy52YWx1ZURhdGEgPSB2O1xuICAgICAgdGhpcy5vbkNoYW5nZSh2KTtcbiAgICB9XG4gIH1cblxuICBAT3V0cHV0KCkgYWRkID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAT3V0cHV0KCkgcmVtb3ZlID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAT3V0cHV0KCkgdElucHV0ID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB0YWdpZnlTZXJ2aWNlOiBUYWdpZnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgZWxlbWVudDogRWxlbWVudFJlZjxIVE1MRWxlbWVudD5cbiAgKSB7IH1cblxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgdGhpcy5zZXR0aW5ncy5jYWxsYmFja3MgPSB0aGlzLnNldHRpbmdzLmNhbGxiYWNrcyB8fCB7fTtcblxuICAgIGlmICghdGhpcy5zZXR0aW5ncy5jYWxsYmFja3MuaGFzT3duUHJvcGVydHkoJ2FkZCcpKSB7XG4gICAgICB0aGlzLnNldHRpbmdzLmNhbGxiYWNrcy5hZGQgPSAoKSA9PiB0aGlzLmFkZC5lbWl0KHtcbiAgICAgICAgdGFnczogdGhpcy50YWdpZnkudmFsdWUsXG4gICAgICAgIGFkZGVkOiB0aGlzLnRhZ2lmeS52YWx1ZVt0aGlzLnRhZ2lmeS52YWx1ZS5sZW5ndGggLSAxXVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnNldHRpbmdzLmNhbGxiYWNrcy5oYXNPd25Qcm9wZXJ0eSgncmVtb3ZlJykpIHtcbiAgICAgIHRoaXMuc2V0dGluZ3MuY2FsbGJhY2tzLnJlbW92ZSA9ICgpID0+IHRoaXMucmVtb3ZlLmVtaXQodGhpcy50YWdpZnkudmFsdWUpO1xuICAgIH1cblxuICAgIGNvbnN0IGlubmVyVGV4dCA9IHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50LnRleHRDb250ZW50O1xuXG4gICAgdGhpcy50YWdpZnkgPSBuZXcgVGFnaWZ5KHRoaXMuaW5wdXRSZWYubmF0aXZlRWxlbWVudCwgdGhpcy5zZXR0aW5ncyk7XG5cbiAgICAvLyBhZGQgdG8gc2VydmljZSBpZiBuYW1lIGlzIHByb3ZpZGVkXG4gICAgaWYgKHRoaXMubmFtZS5sZW5ndGgpIHtcbiAgICAgIHRoaXMudGFnaWZ5U2VydmljZS5hZGQodGhpcy5uYW1lLCB0aGlzLnRhZ2lmeSk7XG4gICAgfVxuXG4gICAgdGhpcy5zZXRSZWFkb25seSgpO1xuXG4gICAgLy8gaWYgdGhlcmUgaXMgc29tZSB0ZXh0IGluc2lkZSBjb21wb25lbnQsIGxvYWQgdGhpcyB2YWx1ZSBhbmQgc2tpcCBmaXJzdCBjaGFuZ2UgY2hlY2tcbiAgICBpZiAoaW5uZXJUZXh0Lmxlbmd0aCkge1xuICAgICAgdGhpcy50YWdpZnkubG9hZE9yaWdpbmFsVmFsdWVzKGlubmVyVGV4dCk7XG4gICAgICB0aGlzLnNraXAgPSB0cnVlO1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRoaXMuc2V0VmFsdWUoKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIGxpc3RlbiB0byB2YWx1ZSBjaGFuZ2VzIGZyb20gb3V0c2lkZVxuICAgIHRoaXMudmFsdWUkXG4gICAgICAucGlwZSh0YWtlVW50aWwodGhpcy51bnN1YnNjcmliZSQpKVxuICAgICAgLnN1YnNjcmliZSh0YWdzID0+IHtcblxuICAgICAgICBpZiAoIXRhZ3MpIHsgcmV0dXJuOyB9XG5cbiAgICAgICAgaWYgKHRoaXMuc2tpcCkge1xuICAgICAgICAgIHRoaXMuc2tpcCA9IGZhbHNlO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnZhbHVlVHlwZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICB0aGlzLnZhbHVlVHlwZSA9IHR5cGVvZiB0YWdzO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gaWYgc3RyaW5nIGlzIHBhc3NlZCwgZS5nLiB2aWEgcmVhY3RpdmUgZm9ybXNcbiAgICAgICAgaWYgKHR5cGVvZiB0YWdzID09PSAnc3RyaW5nJykge1xuICAgICAgICAgIHRoaXMudGFnaWZ5LmxvYWRPcmlnaW5hbFZhbHVlcyh0YWdzKTtcbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUoKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAvLyBhZGQgYWxsIHRhZ3MgKGFscmVhZHkgZXhpc3RpbmcgdGFncyB3aWxsIGJlIHNraXBwZWRcbiAgICAgICAgdGhpcy50YWdpZnkuYWRkVGFncyh0YWdzLCBmYWxzZSwgdHJ1ZSk7XG5cbiAgICAgICAgLy8gcmVtb3ZlIGFsbCB0YWdzIHRoYXQgYXJlIG5vdCBwYXJ0IG9mIHZhbHVlIGFueW1vcmVcbiAgICAgICAgdGhpcy50YWdpZnkudmFsdWUuZm9yRWFjaCh2ID0+IHtcbiAgICAgICAgICBpZiAoIXRhZ3MuZmluZCh0ID0+IHQudmFsdWUgPT09IHYudmFsdWUpKSB7XG4gICAgICAgICAgICAvLyBzb21laG93IHJlbW92ZVRhZ3MoKSB3aXRoIHN0cmluZyBwYXJhbWV0ZXIgZG9lc24ndCBhbHdheXMgZmluZCB0aGUgdGFnIGVsZW1lbnRcbiAgICAgICAgICAgIC8vIHRoaXMgaXMgYSB3b3JrYXJvdW5kIGZvciBmaW5kaW5nIHRoZSByaWdodCB0YWcgZWxlbWVudFxuICAgICAgICAgICAgY29uc3QgdGFnRWxtID0gdGhpcy50YWdpZnkuZ2V0VGFnRWxtcygpLmZpbmQoZWwgPT4gZWwuYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oJ3ZhbHVlJykudGV4dENvbnRlbnQgPT09IHYudmFsdWUpO1xuICAgICAgICAgICAgdGhpcy50YWdpZnkucmVtb3ZlVGFncyh0YWdFbG0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgIH0pO1xuXG4gICAgLy8gbGlzdGVuIHRvIHRhZ2lmeSBldmVudHNcbiAgICB0aGlzLnRhZ2lmeS5vbignaW5wdXQnLCBlID0+IHtcbiAgICAgIHRoaXMudElucHV0LmVtaXQoZS5kZXRhaWwudmFsdWUpO1xuICAgICAgaWYgKHRoaXMudmFsdWVUeXBlID09PSAnc3RyaW5nJyAmJiB0aGlzLnRhZ2lmeS5zZXR0aW5ncy5tb2RlID09PSAnbWl4Jykge1xuICAgICAgICB0aGlzLnZhbHVlID0gdGhpcy50YWdpZnkuZ2V0TWl4ZWRUYWdzQXNTdHJpbmcoKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIG1lcmdlKFxuICAgICAgZnJvbUV2ZW50KHRoaXMudGFnaWZ5LCAnYWRkJyksXG4gICAgICBmcm9tRXZlbnQodGhpcy50YWdpZnksICdyZW1vdmUnKVxuICAgIClcbiAgICAgIC5waXBlKFxuICAgICAgICAvLyB0aHJvdHRsZSB1c2VkIHRvIHJlZHVjZSBudW1iZXIgb2YgdmFsdWUgY2hhbmdlcyB3aGVuIGFkZGluZy9yZW1vdmluZyBhIGJ1bmNoIG9mIHRhZ3NcbiAgICAgICAgdGhyb3R0bGVUaW1lKDAsIGFzeW5jU2NoZWR1bGVyLCB7IGxlYWRpbmc6IGZhbHNlLCB0cmFpbGluZzogdHJ1ZSB9KSxcbiAgICAgICAgdGFrZVVudGlsKHRoaXMudW5zdWJzY3JpYmUkKVxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIHRoaXMuc2V0VmFsdWUoKTtcbiAgICAgIH0pO1xuXG4gICAgLy8gbGlzdGVuIHRvIHN1Z2dlc3Rpb25zIHVwZGF0ZXNcbiAgICBpZiAodGhpcy53aGl0ZWxpc3QpIHtcbiAgICAgIHRoaXMud2hpdGVsaXN0XG4gICAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLnVuc3Vic2NyaWJlJCkpXG4gICAgICAgIC5zdWJzY3JpYmUobGlzdCA9PiB7XG4gICAgICAgICAgdGhpcy50YWdpZnkuc2V0dGluZ3Mud2hpdGVsaXN0ID0gbGlzdDtcbiAgICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgd3JpdGVWYWx1ZSh0YWdzOiBzdHJpbmd8VGFnRGF0YVtdKSB7XG4gICAgdGhpcy52YWx1ZSQubmV4dCh0YWdzKTtcbiAgfVxuXG4gIHJlZ2lzdGVyT25DaGFuZ2UoZm46IGFueSkge1xuICAgIHRoaXMub25DaGFuZ2UgPSBmbjtcbiAgfVxuXG4gIHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiBhbnkpIHtcbiAgICB0aGlzLm9uVG91Y2hlZCA9IGZuO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRWYWx1ZSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy52YWx1ZVR5cGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICB0aGlzLnZhbHVlID0gdGhpcy50YWdpZnkuRE9NLm9yaWdpbmFsSW5wdXQudmFsdWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudmFsdWUgPSB0aGlzLnRhZ2lmeS52YWx1ZS5zbGljZSgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUYWdpZnkgY3JlYXRlcyBhIGB0YWdzYCBlbGVtZW50IHRvIHdoaWNoIHRoZSBjbGFzc2VzIG9mIHRoZSBgaW5wdXRgIGVsZW1lbnQgYXJlIGFwcGxpZWQuXG4gICAqIENoYW5nZXMgb2YgYGlucHV0Q2xhc3NgIGFyZSBhcHBsaWVkIGF1dG9tYXRpY2FsbHkgdG8gdGhlIGBpbnB1dGAgZWxlbWVudCwgYnV0IGhhdmUgdG8gYmVcbiAgICogbWFudWFsbHkgYXBwbGllZCB0byB0aGUgYHRhZ3NgIGVsZW1lbnQuXG4gICAqL1xuICBwcml2YXRlIHNldFRhZ3NDbGFzcyh2OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCB0YWdzRWxlbWVudCA9IHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ3RhZ3MnKTtcbiAgICBpZiAodGFnc0VsZW1lbnQpIHtcbiAgICAgIHRhZ3NFbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoLi4udGhpcy5pbnB1dENsYXNzVmFsdWUuc3BsaXQoL1xccysvKSk7XG4gICAgICB0YWdzRWxlbWVudC5jbGFzc0xpc3QuYWRkKC4uLnYuc3BsaXQoL1xccysvKSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRSZWFkb25seSgpIHtcbiAgICBpZiAodGhpcy50YWdpZnkpIHtcbiAgICAgIHRoaXMudGFnaWZ5LnNldFJlYWRvbmx5KHRoaXMucmVhZG9ubHlWYWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy51bnN1YnNjcmliZSQubmV4dCgpO1xuICAgIHRoaXMudW5zdWJzY3JpYmUkLmNvbXBsZXRlKCk7XG5cbiAgICB0aGlzLnRhZ2lmeS5kZXN0cm95KCk7XG5cbiAgICBpZiAodGhpcy5uYW1lLmxlbmd0aCkge1xuICAgICAgdGhpcy50YWdpZnlTZXJ2aWNlLnJlbW92ZSh0aGlzLm5hbWUpO1xuICAgIH1cbiAgfVxuXG59XG4iXX0=